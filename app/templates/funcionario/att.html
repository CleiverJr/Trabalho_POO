{% extends "templs/navfunc.html" %}
{% block title %} Atualizar Cadastro {% endblock %}
{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/att.css') }}"> {% endblock %}
{% block content %}
<form id="dynamicForm" class="w-100">
    <!-- Dropdown Principal -->
    <div class="mb-5 w-50">
        <label for="userType" class="form-label text-white fs-2 fw-bold mb-3">Selecione o Tipo de Usuário:</label>
        <select id="userType" class="form-select w-50" onchange="updateForm()">
            <option value="Cliente">Cliente</option>
            <option value="Funcionário">Funcionário</option>
        </select>
    </div>

    <!-- Inputs para Cliente -->
    <div id="clienteInputs">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-5">
                    <input name="searchKey" type="text" class="form-control" id="clienteNome" placeholder="Nome">
                </div>
                <div class="mb-5">
                    <input type="email" class="form-control" id="clienteEmail" placeholder="Email">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteDepartamentos" placeholder="Departamentos">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteReceita" placeholder="Receita">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-5">
                    <select id="identifierDropdown" onchange="loadUserData()">
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteSede" placeholder="Sede">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteFuncionarios" placeholder="N° de Funcionários">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clientePv" placeholder="Proposta de valor">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteTelefone" placeholder="Telefone">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteIndústria" placeholder="Indústria">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteCapital" placeholder="Capital">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="clienteSenha" placeholder="Senha">
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center mt-4 gap-3">
            <button type="button" class="btn UIButton" onclick="atualizarCliente()">Atualizar Cliente</button>
        </div>
    </div>

    <!-- Inputs para Funcionário -->
    <div id="funcionarioInputs" class="hidden">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioNome" placeholder="Nome">
                </div>
                <div class="mb-5">
                    <input type="email" class="form-control" id="funcionarioEmail" placeholder="Email">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioSalario" placeholder="Salário">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioSenha" placeholder="Senha">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-5">
                    <select id="identifierDropdown" onchange="loadUserData()">
                        <option value="">Selecione um funcionário</option>
                    </select>
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioCep" placeholder="CEP">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioFormacao" placeholder="Formacao">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioTipo" placeholder="Tipo">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioTelefone" placeholder="Telefone">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioCargo" placeholder="Cargo">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioIdade" placeholder="Idade">
                </div>
                <div class="mb-5">
                    <input type="text" class="form-control" id="funcionarioGrau" placeholder="Grau">
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center mt-4 gap-3">
            <button type="button" class="btn UIButton" onclick="atualizarFuncionario()">Atualizar Funcionário</button>
        </div>
    </div>
</form>
{% endblock %}
{% block script %}
<script>
    async function loadDropdown() {
    try {
        const response = await fetch("/get_all_contracts"); // Rota para obter todos os contratos
        const contracts = await response.json();

        if (response.ok) {
            const dropdown = document.getElementById('identifierDropdown');
            dropdown.innerHTML = '<option value="">Selecione um cliente</option>'; // Resetar as opções

            Object.keys(contracts).forEach(cliente => {
                const contract = contracts[cliente];
                const cpfOuCnpj = contract.clienteCnpj || contract.funcionarioCpf || "Sem identificador";
                const option = document.createElement('option');
                option.value = cpfOuCnpj;
                option.textContent = `${cliente} (${cpfOuCnpj})`;
                dropdown.appendChild(option);
            });
        } else {
            alert("Erro ao carregar os contratos: " + contracts.error);
        }
    } catch (error) {
        console.error("Erro na requisição:", error);
        alert("Erro ao carregar os contratos.");
    }
}

// Chamar a função para carregar o dropdown quando a página for carregada
document.addEventListener('DOMContentLoaded', loadDropdown);

async function loadUserData(userType) {
    const identifier = document.getElementById(userType === 'Cliente' ? 'clienteCnpj' : 'funcionarioCpf').value;

    try {
        const response = await fetch(`/get_att/${userType}/${identifier}`);
        const data = await response.json();

        if (response.ok) {
            // Preencher o formulário com os dados retornados
            if (userType === 'Cliente') {
                document.getElementById('clienteNome').value = data.clienteNome || "";
                document.getElementById('clienteEmail').value = data.clienteEmail || "";
                document.getElementById('clienteDepartamentos').value = data.clienteDepartamentos || "";
                document.getElementById('clienteReceita').value = data.clienteReceita || "";
                document.getElementById('clienteSede').value = data.clienteSede || "";
                document.getElementById('clienteFuncionarios').value = data.clienteFuncionarios || "";
                document.getElementById('clientePv').value = data.clientePv || "";
                document.getElementById('clienteTelefone').value = data.clienteTelefone || "";
                document.getElementById('clienteIndustria').value = data.clienteIndustria || "";
                document.getElementById('clienteCapital').value = data.clienteCapital || "";
                document.getElementById('clienteSenha').value = data.clienteSenha || "";
            } else if (userType === 'Funcionário') {
                document.getElementById('funcionarioNome').value = data.funcionarioNome || "";
                document.getElementById('funcionarioEmail').value = data.funcionarioEmail || "";
                document.getElementById('funcionarioSalario').value = data.funcionarioSalario || "";
                document.getElementById('funcionarioSenha').value = data.funcionarioSenha || "";
                document.getElementById('funcionarioCep').value = data.funcionarioCep || "";
                document.getElementById('funcionarioFormação').value = data.funcionarioFormação || "";
                document.getElementById('funcionarioTipo').value = data.funcionarioTipo || "";
                document.getElementById('funcionarioTelefone').value = data.funcionarioTelefone || "";
                document.getElementById('funcionarioCargo').value = data.funcionarioCargo || "";
                document.getElementById('funcionarioIdade').value = data.funcionarioIdade || "";
                document.getElementById('funcionarioGrau').value = data.funcionarioGrau || "";
            }
        } else {
            alert("Erro ao carregar os dados: " + data.error);
        }
    } catch (error) {
        console.error("Erro na requisição:", error);
        alert("Erro ao carregar os dados.");
    }
}



    async function updateForm() {
        const userType = document.getElementById('userType').value;
        const clienteInputs = document.getElementById('clienteInputs');
        const funcionarioInputs = document.getElementById('funcionarioInputs');

        if (userType === 'Cliente') {
            clienteInputs.classList.remove('hidden');
            funcionarioInputs.classList.add('hidden');
        } else if (userType === 'Funcionário') {
            clienteInputs.classList.add('hidden');
            funcionarioInputs.classList.remove('hidden');
        }
    }


    async function adicionarCliente() {
        const identifier = document.getElementById('clienteCnpj').value;
        const updatedData = {
            clienteNome: document.getElementById('clienteNome').value,
            clienteEmail: document.getElementById('clienteEmail').value,
            clienteDepartamentos: document.getElementById('clienteDepartamentos').value,
            clienteReceita: document.getElementById('clienteReceita').value,
            clienteSede: document.getElementById('clienteSede').value,
            clienteFuncionarios: document.getElementById('clienteFuncionarios').value,
            clientePv: document.getElementById('clientePv').value,
            clienteTelefone: document.getElementById('clienteTelefone').value,
            clienteIndustria: document.getElementById('clienteIndustria').value,
            clienteCapital: document.getElementById('clienteCapital').value,
            clienteSenha: document.getElementById('clienteSenha').value
        };

        try {
            const response = await fetch(`/update_att/${identifier}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updatedData)
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
            } else {
                alert("Erro ao atualizar os dados: " + result.error);
            }
        } catch (error) {
            console.error("Erro na requisição:", error);
            alert("Erro ao atualizar os dados.");
        }
    }
</script>


{% endblock %}